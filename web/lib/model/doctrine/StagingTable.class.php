<?php

/**
 * StagingTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class StagingTable extends DarwinTable
{
  /**
   * Returns an instance of this class.
   *
   * @return object StagingTable
   */
  public static function getInstance()
  {
      return Doctrine_Core::getTable('Staging');
  }
  
  /**
  * Get distinct Host Relationships
  * @return Doctrine_collection with distinct "host_relationship" as column
  */
  public function getDistinctHostRelationships()
  {
      return $this->createFlatDistinct('specimens', 'host_relationship', 'host_relationship')->execute();
  }

  public function findLinked($record_ids)
  {
    if(! count($record_ids)) return array();
    $conn = Doctrine_Manager::connection();
    $sql = "select record_id, count(*) as cnt FROM template_table_record_ref r where referenced_relation='staging' and 
      record_id in (".implode(',',$record_ids).") GROUP BY record_id";
    $result = $conn->fetchAssoc($sql);
    return $result;
  }

  public function markTaxon($import_ref)
  {
    $q = Doctrine_Query::create()
      ->update('Staging')
      ->set('create_taxon', '?','true')
      ->andwhere('import_ref = ? ',$import_ref)
      ->execute();
    $q = Doctrine_Query::create()->update('Imports')

      ->set('state', '?','processing')
	  ->andwhere('id = ? ',$import_ref)
      ->execute();
	      //ftheeten 2017 09 22   
		  $q = Doctrine_Query::create()->update('Imports')

      ->set('state', '?','processing')
	  ->andwhere('id = ? ',$import_ref)
      ->execute();
      /*$q = Doctrine_Query::create()->update('Imports');
      $q->andwhere('id = ? ',$import_ref)
      ->set('state', '?','aprocessing')
      ->execute();*/
      /*
      $cmd='darwin:check-import --do-import --id='.$import_ref;
          $conn = Doctrine_Manager::connection();
    $this->setImportAsWorking($conn, array($import_ref), true);
    $currentDir=getcwd();
    chdir(sfconfig::get('sf_root_dir'));    
    exec('nohup php symfony '.$cmd.'  >/dev/null &' );
    chdir($currentDir); */
  }
  
   //ftheeten 2017 08 28
  public function setImportAsWorking( $p_conn, $p_ids, $p_working)
  {
    if(count($p_ids)>0)
    {
        $p_conn->beginTransaction();
        foreach($p_ids as $id)
        {
         Doctrine_Query::create()
            ->update('imports p')
            ->set('p.working','?',((int)$p_working==0)?'f':'t')
            ->where('p.id = ?', $id)
            ->execute();
        }
        $p_conn->commit();
    }
  }    
}
