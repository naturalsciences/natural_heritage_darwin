<?php

/**
 * StagingCatalogueTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class StagingCatalogueTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object StagingCatalogueTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('StagingCatalogue');
    }
    
    //ftheeten 2019 02 14
    public function getByImportRef($import_ref, $offset="0", $limit="1000")
    {
        /* $q = Doctrine_Query::create()
            ->From('StagingCatalogue s')
            ->where('s.import_ref = ?', $import_ref)
            ->orderBy("id ASC");
		
        $items = array_slice($q->execute(), $offset, $limit);
		*/
		
		$conn_MGR = Doctrine_Manager::connection();
		$conn = $conn_MGR->getDbh();
			
			
		$params[':import_ref'] = $import_ref;
		$params[':offset'] = $offset;
	    $params[':limit'] = $limit;
		$sql =" SELECT * FROM staging_catalogue WHERE import_ref=:import_ref ORDER BY id OFFSET :offset LIMIT :limit;";
		$statement = $conn->prepare($sql);
		$statement->execute($params);
		$items = $statement->fetchAll(PDO::FETCH_ASSOC);
        return $items;
    }
	
	public function countExceptionMessages($import_ref, $offset="0", $limit="1000")
	{
		$conn_MGR = Doctrine_Manager::connection();
		$conn = $conn_MGR->getDbh();
			
			
		$params[':import_ref'] = $import_ref;
		$params[':import_ref_2'] = $import_ref;
		$params[':offset'] = $offset;
	    $params[':limit'] = $limit;
		$sql =" SELECT count(*) as count, import_exception, (SELECT count(*) FROM staging_catalogue WHERE import_ref=:import_ref_2   ) as count_all FROM (SELECT * FROM staging_catalogue WHERE import_ref=:import_ref ORDER BY id  OFFSET :offset LIMIT :limit) a  GROUP BY import_exception ORDER BY import_exception  ;";
		$statement = $conn->prepare($sql);
		$statement->execute($params);
		$results = $statement->fetchAll(PDO::FETCH_ASSOC);
		return $results;
	}
    
}
