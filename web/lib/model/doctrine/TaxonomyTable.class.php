<?php
/**
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class TaxonomyTable extends DarwinTable
{

  public function getTaxonByName($name,$level,$path)
  {
    $q = Doctrine_Query::create()
      ->from('Taxonomy t')
      ->where('t.name = ?', $name)
      ->andWhere('t.level_ref = ?', $level)
      ->andWhere('t.path = ?', $path);

    return $q->fetchOne();
  }

  public function getRealTaxon()
  {
    $q = Doctrine_Query::create()
      ->from('Taxonomy t')
      ->where('t.id > 0') ;
      return $q->execute() ;
  }
  
  //ftheeten 2017 06 26
  public function getTaxonByNameAndCollectionAndLevel($name, $level, $collections)
  {
        $conn = Doctrine_Manager::connection();
        $sql = "SELECT DISTINCT name as label, name_indexed,  id as value  FROM taxonomy 
                 INNER JOIN
                (
                       SELECT distinct unnest(string_to_array(taxon_path||'/'||taxon_ref::varchar, '/'))  as key_taxon from specimens where  collection_ref IN (".$collections.")
                        AND taxon_path is not null 
                ) AS specimens
                        ON
                        taxonomy.id::text = specimens.key_taxon
                WHERE  level_ref=:rank_id
                AND taxonomy.name_indexed LIKE CONCAT((SELECT * FROM fulltoindex(:prefix)),'%') 
                ORDER BY name LIMIT 30;";
        $q = $conn->prepare($sql);
		$q->execute(array(':rank_id'=> $level, ':prefix'=>$name ));
        $res = $q->fetchAll(PDO::FETCH_ASSOC);

        return $res;
  }
  
  //ftheeten 2017 06 26
  public function getTaxonByNameAndCollection($name, $collections)
  {
        $conn = Doctrine_Manager::connection();
        $sql = "SELECT DISTINCT name as label, name_indexed,  id as value FROM taxonomy 
                 INNER JOIN
                (
                       SELECT distinct unnest(string_to_array(taxon_path||'/'||taxon_ref::varchar, '/'))  as key_taxon from specimens where  collection_ref IN (".$collections.")
                        AND taxon_path is not null 
                ) AS specimens
                        ON
                        taxonomy.id::text = specimens.key_taxon
                WHERE taxonomy.name_indexed LIKE CONCAT((SELECT * FROM fulltoindex(:prefix)),'%') 
                ORDER BY name LIMIT 30;";
        $q = $conn->prepare($sql);
		$q->execute(array(':prefix'=>$name ));
        $res = $q->fetchAll(PDO::FETCH_ASSOC);

        return $res;
  }
  
   //ftheeten 2017 06 26
  public function getTaxonByNameAndLevel($name, $level)
  {
        $conn = Doctrine_Manager::connection();
        $sql = "SELECT DISTINCT name as label, name_indexed,  id as value  FROM taxonomy 
                 INNER JOIN
                (
                       SELECT distinct unnest(string_to_array(taxon_path||'/'||taxon_ref::varchar, '/'))  as key_taxon from specimens where  taxon_path is not null 
                ) AS specimens
                        ON
                        taxonomy.id::text = specimens.key_taxon
                WHERE  level_ref=:rank_id
                AND taxonomy.name_indexed LIKE CONCAT((SELECT * FROM fulltoindex(:prefix)),'%') 
                ORDER BY name LIMIT 30;";
        $q = $conn->prepare($sql);
		$q->execute(array(':rank_id'=> $level, ':prefix'=>$name ));
        $res = $q->fetchAll(PDO::FETCH_ASSOC);

        return $res;
  }
}
